{% extends 'base.html' %}

{% block title %}Descriptive Analytics - Campus Lost and Found{% endblock %}

{% block extra_head %}
<!-- Chart.js CDN - Multiple fallback options -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
<script>
// Fallback if the first CDN fails
if (typeof Chart === 'undefined') {
    document.write('<script src="https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js"><\/script>');
}
</script>
<style>
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        margin-bottom: 20px;
    }
    .insight-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
    }
    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
    }
    .tab-content.active {
        display: block;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Descriptive Analytics</h1>
                <p class="text-gray-600">Show what is happening on campus</p>
            </div>
            <div class="flex items-center space-x-3">
                <a href="{% url 'analytics:diagnostic' %}" 
                   class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition duration-200">
                    Diagnostic Analytics
                    <svg class="h-4 w-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </a>
            </div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <form method="GET" action="{% url 'analytics:descriptive' %}" class="flex flex-wrap gap-4 items-end">
            <div class="flex flex-col min-w-[160px]">
                <label class="text-sm font-medium text-gray-700 mb-1">Date From</label>
                <input type="date" name="date_from" value="{{ date_from }}" 
                       class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="flex flex-col min-w-[160px]">
                <label class="text-sm font-medium text-gray-700 mb-1">Date To</label>
                <input type="date" name="date_to" value="{{ date_to }}" 
                       class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="flex gap-2">
                <button type="submit" 
                        class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 transition duration-200">
                    Apply Filters
                </button>
                <a href="{% url 'analytics:descriptive' %}" 
                   class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700 transition duration-200">
                    Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Navigation Tabs -->
    <div class="flex border-b-2 border-gray-200 mb-6 gap-2 overflow-x-auto">
        <button class="nav-tab active" data-tab="categories">
            <span class="flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                </svg>
                Item Categories
            </span>
        </button>
        <button class="nav-tab" data-tab="locations">
            <span class="flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Loss Locations
            </span>
        </button>
        <button class="nav-tab" data-tab="monthly">
            <span class="flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Monthly Trends
            </span>
        </button>
    </div>

    <!-- Most Commonly Lost Item Categories Tab -->
    <div id="categories" class="tab-content active">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Lost Item Categories</h3>
            <p class="text-gray-600 mb-4">Identify what users most often lose</p>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 mt-4">
                <h4 class="text-md font-medium text-gray-900 mb-3">Summary Table</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for item in category_analytics %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.category|title }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.count }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{% widthratio item.count total_reports 100 %}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="insight-card">
                <p class="text-sm">
                    <strong>Insight:</strong> 
                    {% with first_category=category_analytics.first %}
                    {% if first_category %}
                    This chart suggests that <strong>{{ first_category.category|title }}</strong> items are lost most frequently, 
                    which may be due to students using shared outlets and study areas. Consider implementing better tracking 
                    systems and awareness campaigns for this category.
                    {% endif %}
                    {% endwith %}
                </p>
            </div>
        </div>
    </div>

    <!-- Most Frequent Item Loss Locations Tab -->
    <div id="locations" class="tab-content">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Locations Where Items Are Lost</h3>
            <p class="text-gray-600 mb-4">Detect campus hotspots for lost items</p>
            <div class="chart-container">
                <canvas id="locationChart"></canvas>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 mt-4">
                <h4 class="text-md font-medium text-gray-900 mb-3">Summary Table</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for item in location_analytics %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.location }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.count }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{% widthratio item.count total_reports 100 %}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="insight-card">
                <p class="text-sm">
                    <strong>Insight:</strong> 
                    {% with first_location=location_analytics.first %}
                    {% if first_location %}
                    <strong>{{ first_location.location }}</strong> is the primary hotspot for lost items on campus. 
                    This location may have high foot traffic, limited supervision, or environmental factors that 
                    contribute to item loss. Consider implementing additional security measures, better signage, 
                    or staff supervision in this area.
                    {% endif %}
                    {% endwith %}
                </p>
            </div>
        </div>
    </div>

    <!-- Monthly Trend of Lost Item Reports Tab -->
    <div id="monthly" class="tab-content">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Monthly Lost Item Reports</h3>
            <p class="text-gray-600 mb-4">Understand when losses spike (e.g., semester start, exams)</p>
            <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 mt-4">
                <h4 class="text-md font-medium text-gray-900 mb-3">Summary Table</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reports</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for item in monthly_analytics %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.month }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.count }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{% widthratio item.count total_reports 100 %}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="insight-card">
                <p class="text-sm">
                    <strong>Insight:</strong> 
                    {% with peak_month=monthly_analytics.first %}
                    {% if peak_month %}
                    <strong>{{ peak_month.month }}</strong> shows the highest number of lost item reports, which likely 
                    correlates with academic calendar events such as semester start, exam periods, or campus activities. 
                    This pattern suggests the need for targeted awareness campaigns and additional support during these 
                    high-risk periods.
                    {% endif %}
                    {% endwith %}
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Global chart instances to prevent memory leaks
let chartInstances = {};

document.addEventListener('DOMContentLoaded', function() {
    console.log('Descriptive Analytics - DOM Content Loaded');
    
    // Try to load Chart.js with multiple strategies
    loadChartJS().then(() => {
        console.log('Chart.js loaded successfully');
        initializeTabs();
        initializeActiveTab();
    }).catch(error => {
        console.error('Failed to load Chart.js:', error);
        showChartError();
    });
});

function loadChartJS() {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 100; // 10 seconds max wait
        
        const checkChartJS = () => {
            attempts++;
            if (typeof Chart !== 'undefined') {
                resolve();
            } else if (attempts >= maxAttempts) {
                // Try loading from a different CDN as last resort
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js';
                script.onload = () => {
                    if (typeof Chart !== 'undefined') {
                        resolve();
                    } else {
                        reject(new Error('Chart.js failed to load from all sources'));
                    }
                };
                script.onerror = () => reject(new Error('Chart.js failed to load from all sources'));
                document.head.appendChild(script);
            } else {
                setTimeout(checkChartJS, 100);
            }
        };
        
        checkChartJS();
    });
}

function showChartError() {
    const chartContainers = document.querySelectorAll('.chart-container');
    chartContainers.forEach(container => {
        container.innerHTML = `
            <div class="flex items-center justify-center h-full bg-gray-100 rounded-lg">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <p class="mt-2 text-sm text-gray-500">Chart loading failed</p>
                </div>
            </div>
        `;
    });
}

function initializeTabs() {
    console.log('Initializing tabs...');
    const tabs = document.querySelectorAll('.nav-tab');
    const contents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            console.log('Tab clicked:', targetTab);
            
            // Remove active class from all tabs and contents
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            const targetContent = document.getElementById(targetTab);
            if (targetContent) {
                targetContent.classList.add('active');
                console.log('Activated content:', targetTab);
                
                // Initialize chart for the newly active tab
                setTimeout(() => {
                    initializeChartForTab(targetTab);
                }, 100);
            }
        });
    });
}

function initializeActiveTab() {
    const activeTab = document.querySelector('.nav-tab.active');
    if (activeTab) {
        const activeTabId = activeTab.getAttribute('data-tab');
        initializeChartForTab(activeTabId);
    }
}

function initializeChartForTab(tabId) {
    console.log('Initializing chart for tab:', tabId);
    
    // Destroy existing chart for this tab
    if (chartInstances[tabId]) {
        chartInstances[tabId].destroy();
        delete chartInstances[tabId];
    }
    
    try {
        const chartData = {{ chart_data|safe }};
        
        if (tabId === 'categories') {
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx && chartData.categories) {
                console.log('Creating category chart');
                chartInstances[tabId] = new Chart(categoryCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: chartData.categories.labels,
                        datasets: [{
                            label: 'Lost Items',
                            data: chartData.categories.data,
                            backgroundColor: '#3B82F6',
                            borderColor: '#2563EB',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#f3f4f6'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                console.log('Category chart created successfully');
            }
        } else if (tabId === 'locations') {
            const locationCtx = document.getElementById('locationChart');
            if (locationCtx && chartData.locations) {
                console.log('Creating location chart');
                chartInstances[tabId] = new Chart(locationCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: chartData.locations.labels,
                        datasets: [{
                            label: 'Lost Items',
                            data: chartData.locations.data,
                            backgroundColor: '#10B981',
                            borderColor: '#059669',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#f3f4f6'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                console.log('Location chart created successfully');
            }
        } else if (tabId === 'monthly') {
            const monthlyCtx = document.getElementById('monthlyChart');
            if (monthlyCtx && chartData.monthly) {
                console.log('Creating monthly chart');
                chartInstances[tabId] = new Chart(monthlyCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: chartData.monthly.labels,
                        datasets: [{
                            label: 'Reports',
                            data: chartData.monthly.data,
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#F59E0B',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#f3f4f6'
                                }
                            },
                            x: {
                                grid: {
                                    color: '#f3f4f6'
                                }
                            }
                        }
                    }
                });
                console.log('Monthly chart created successfully');
            }
        }
    } catch (error) {
        console.error('Error creating chart for tab:', tabId, error);
    }
}
</script>

<style>
/* Enhanced tab styling with regular CSS */
.nav-tab {
    padding: 0.75rem 1.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #4b5563;
    background-color: #f3f4f6;
    border: 1px solid #d1d5db;
    border-top-left-radius: 0.5rem;
    border-top-right-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}

.nav-tab:hover {
    background-color: #e5e7eb;
    color: #1f2937;
}

.nav-tab.active {
    background-color: white;
    color: #4f46e5;
    border-color: #4f46e5;
    border-bottom-color: white;
    position: relative;
    z-index: 10;
}

.nav-tab.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background-color: white;
    z-index: 1;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}
</style>
{% endblock %} 